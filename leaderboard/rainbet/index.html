<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>McPlayGT | Rainbet Leaderboard</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link
    rel="icon"
    href="https://i.postimg.cc/PxjzYRr0/image.png"
    type="image/png"
  />
  <style>
    /* Minimal styles to prevent layout break by countdown */
    #date-range-container {
      text-align: center;
      margin: 20px 0;
      color: #ffd500;
      font-weight: 600;
      font-size: 16px;
    }
    #countdown {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 6px;
    }
    #countdown .counter {
      background: #222;
      padding: 8px 10px;
      border-radius: 8px;
      min-width: 52px;
      font-weight: 700;
      color: #ffd500;
    }
    #countdown .label {
      font-size: 12px;
      text-align: center;
      margin-top: 2px;
      color: #ffd500cc;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Rules Modal (unchanged) ... -->

  <!-- Header and other markup unchanged ... -->

  <section class="swiperSection">
    <div class="container">
      <!-- ... other markup unchanged ... -->

      <div class="modelButtons d-flex align-center justify-center">
        <p class="btnPara" id="site-code">CODE: LOADING...</p>
        <button class="btnPara rules-btn" id="prev-leaderboard-btn" style="margin-left: 12px;">
          <i class="fa-solid fa-clock-rotate-left"></i> PREVIOUS LEADERBOARD
        </button>
        <button class="btnPara rules-btn" id="rules-btn" style="display: none;">
          <i class="fa-solid fa-info-circle"></i> RULES
        </button>
      </div>

      <!-- Countdown & Date Range container -->
      <div id="date-range-container">
        <!-- Content inserted dynamically -->
      </div>

      <!-- Leaderboard cards and table markup remain unchanged -->
      <div class="row gridRow d-flex align-center justify-center">
        <!-- Top 3 Cards as before (user-1, user-2, user-3) -->
      </div>
      <div class="row leaderBoardTable fade-in">
        <div class="col-12" style="overflow-x: auto;">
          <table id="customers">
            <tr>
              <th>Place</th>
              <th>User</th>
              <th>WAGERED</th>
              <th>Reward</th>
            </tr>
            <!-- dynamically filled by JS -->
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer unchanged -->

  <script>
    const siteConfig = {
      rainbet: {
        name: 'Rainbet',
        code: 'McPlayGT',
        url: 'https://rainbet.com/?r=McPlayGT',
        coinIcon: '',
        coinSymbol: '$',
        rewardStructure: {
          1: 400, 2: 200, 3: 100, 4: 50, 5: 25, 6: 25, 7: 0, 8: 0, 9: 0, 10: 0,
        },
      },
    };

    let showingPrevLeaderboard = false;
    let timerInterval = null;

    function getCurrentSite() {
      const path = window.location.pathname;
      const match = path.match(/\/leaderboard\/(\w+)/);
      return match ? match[1] : 'rainbet';
    }

    function formatDateShort(date) {
      const day = date.getDate();
      let suffix = 'th';
      if (day === 1 || day === 21 || day === 31) suffix = 'st';
      else if (day === 2 || day === 22) suffix = 'nd';
      else if (day === 3 || day === 23) suffix = 'rd';
      const month = date.toLocaleString('en-US', { month: 'short' });
      const year = date.getFullYear();
      return `${day}${suffix} ${month} ${year}`;
    }

    function getCurrentLeaderboardRange() {
      const now = new Date();
      return {
        start: new Date(now.getFullYear(), now.getMonth(), 1),
        end: new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59),
      };
    }

    function showDateAndCountdown(usePrev) {
      const container = document.getElementById('date-range-container');
      container.innerHTML = '';

      if (usePrev) {
        // Show previous month range only, no countdown
        const now = new Date();
        const prevFrom = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const prevTo = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
        container.innerHTML = `<div>${formatDateShort(prevFrom)} - ${formatDateShort(prevTo)}</div>
          <div style="color: #999; font-size: 14px; margin-top: 4px;">This leaderboard has ended.</div>`;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
      } else {
        // Show current month countdown
        const { start, end } = getCurrentLeaderboardRange();
        container.innerHTML = `<div>${formatDateShort(start)} - ${formatDateShort(end)}</div>
          <div style="margin-top: 6px; color: #bbb;">Ends in:</div>
          <div id="countdown">
            <div class="counter"><div class="number days">00</div><div class="label">Days</div></div>
            <div class="counter"><div class="number hours">00</div><div class="label">Hours</div></div>
            <div class="counter"><div class="number minutes">00</div><div class="label">Minutes</div></div>
            <div class="counter"><div class="number seconds">00</div><div class="label">Seconds</div></div>
          </div>`;

        if (timerInterval) clearInterval(timerInterval);

        function updateCountdown() {
          const now = Date.now();
          const distance = end.getTime() - now;
          let days = Math.floor(distance / (1000 * 60 * 60 * 24));
          let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
          let seconds = Math.floor((distance % (1000 * 60)) / 1000);
          if (distance < 0) {
            days = hours = minutes = seconds = 0;
          }
          container.querySelector('.days').textContent = String(days).padStart(2, '0');
          container.querySelector('.hours').textContent = String(hours).padStart(2, '0');
          container.querySelector('.minutes').textContent = String(minutes).padStart(2, '0');
          container.querySelector('.seconds').textContent = String(seconds).padStart(2, '0');
        }

        updateCountdown();
        timerInterval = setInterval(updateCountdown, 1000);
      }
    }

    function truncateText(text, maxLength = 12) {
      return text?.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    function getPrizeForRank(rank, rewardStructure, coinSymbol) {
      const prize = rewardStructure[rank];
      if (prize !== undefined) {
        return `${coinSymbol} ${prize.toLocaleString('en-US', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        })}`;
      }
      return 'N/A';
    }

    async function updateLeaderboard(usePrev = false) {
      try {
        const site = getCurrentSite();
        const url = usePrev
          ? 'https://colebeardata.onrender.com/leaderboard/prev'
          : 'https://Sutchyyyslotsdata.onrender.com/leaderboard/top14';
        const response = await fetch(url);
        const data = await response.json();

        const config = siteConfig[site];
        data.sort((a, b) => b.weightedWager - a.weightedWager);

        for (let i = 1; i <= 3; i++) {
          const user = data[i - 1];
          const rank = i;
          if (user) {
            document.getElementById(`user-${i}-img`).src =
              user.img || 'https://i.postimg.cc/sXFPrDBk/rainbetlogo.png';
            const wageredText = user.weightedWager.toLocaleString('en-US', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
            document.getElementById(`user-${i}-wagered`).textContent = `${config.coinSymbol} ${wageredText}`;
            document.getElementById(`user-${i}-name`).textContent = truncateText(user.username);
            const prizeAmount = getPrizeForRank(rank, config.rewardStructure, config.coinSymbol);
            const priceElement = document.getElementById(`user-${i}-price`);
            priceElement.textContent = prizeAmount;
            const prizeCoinIcon = document.getElementById(`prize-coin-icon-${i}`);
            if (prizeAmount !== 'N/A' && config.coinIcon) {
              prizeCoinIcon.style.display = 'inline';
            } else {
              prizeCoinIcon.style.display = 'none';
            }
          } else {
            document.getElementById(`user-${i}-img`).src = 'https://i.postimg.cc/sXFPrDBk/rainbetlogo.png';
            document.getElementById(`user-${i}-name`).textContent = '...';
            document.getElementById(`user-${i}-wagered`).textContent = '0.00';
            document.getElementById(`user-${i}-price`).textContent = 'N/A';
            const prizeCoinIcon = document.getElementById(`prize-coin-icon-${i}`);
            if (prizeCoinIcon) prizeCoinIcon.style.display = 'none';
          }
        }

        const table = document.getElementById('customers');
        while (table.rows.length > 1) {
          table.deleteRow(1);
        }
        data.slice(3).forEach((user, index) => {
          const rank = index + 4;
          const row = table.insertRow();
          row.innerHTML = `
              <th>${rank}.</th>
              <td>
                <div class="d-flex align-center">
                  <img src="${user.img || 'https://i.postimg.cc/sXFPrDBk/rainbetlogo.png'}" alt="" class="img-fluid" />
                  <p>${truncateText(user.username)}</p>
                </div>
              </td>
              <td>
                <div class="d-flex align-center">
                  ${
                    config.coinIcon
                      ? `<img src="${config.coinIcon}" alt="" style="width: 20px; height:20px; margin-right:5px;" />`
                      : ''
                  }
                  <p>${config.coinSymbol} ${user.weightedWager.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })}</p>
                </div>
              </td>
              <td>
                <div class="d-flex align-center">
                  <p>${getPrizeForRank(rank, config.rewardStructure, config.coinSymbol)}</p>
                </div>
              </td>
            `;
        });

        const headingElement = document.getElementById('leaderboard-heading');
        const leaderboardType = usePrev ? 'PREVIOUS' : 'CURRENT';
        headingElement.innerHTML = `${config.name.toUpperCase()} ${leaderboardType} WAGER LEADERBOARD`;

        showDateAndCountdown(usePrev);
      } catch (error) {
        console.error('Error updating leaderboard:', error);
        const headingElement = document.getElementById('leaderboard-heading');
        headingElement.textContent = 'Error loading leaderboard data.';
      }
    }

    async function updatePrevToggleLeaderboard() {
      const btn = document.getElementById('prev-leaderboard-btn');
      if (showingPrevLeaderboard) {
        btn.innerHTML = `<i class="fa-solid fa-trophy"></i> CURRENT LEADERBOARD`;
        await updateLeaderboard(true);
      } else {
        btn.innerHTML = `<i class="fa-solid fa-clock-rotate-left"></i> PREVIOUS LEADERBOARD`;
        await updateLeaderboard(false);
      }
    }

    function openRulesModal() {
      document.getElementById('rulesModal').classList.add('show');
    }
    function closeRulesModal() {
      document.getElementById('rulesModal').classList.remove('show');
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateActiveButton();
      updateSiteContent();
      updateLeaderboard();
      const rulesBtn = document.getElementById('rules-btn');
      if (rulesBtn) {
        rulesBtn.addEventListener('click', openRulesModal);
      }
      const prevBtn = document.getElementById('prev-leaderboard-btn');
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          showingPrevLeaderboard = !showingPrevLeaderboard;
          updatePrevToggleLeaderboard();
        });
      }
    });

    window.addEventListener('popstate', () => {
      updateActiveButton();
      updateSiteContent();
      updateLeaderboard(showingPrevLeaderboard);
    });

    function updateActiveButton() {
      const site = getCurrentSite();
      document.querySelectorAll('.gf-btn').forEach((btn) => {
        btn.classList.remove('gf-btn-active');
        const onclickAttr = btn.getAttribute('onclick');
        const match = onclickAttr && onclickAttr.match(/\/leaderboard\/(\w+)/);
        if (match && match[1] === site) {
          btn.classList.add('gf-btn-active');
        }
      });
    }

    function updateSiteContent() {
      const site = getCurrentSite();
      const config = siteConfig[site];
      const codeBtn = document.getElementById('site-code');
      codeBtn.textContent = `CODE: ${config.code}`;
      codeBtn.onclick = () => window.open(config.url, '_blank');
      const rulesBtn = document.getElementById('rules-btn');
      if (site === 'rainbet') {
        rulesBtn.style.display = 'inline-block';
      } else {
        rulesBtn.style.display = 'none';
      }
      for (let i = 1; i <= 3; i++) {
        const coinIcon = document.getElementById(`coin-icon-${i}`);
        if (coinIcon) {
          if (config.coinIcon) {
            coinIcon.src = config.coinIcon;
            coinIcon.style.width = '20px';
            coinIcon.style.height = '20px';
            coinIcon.style.marginRight = '5px';
            coinIcon.style.display = 'inline';
          } else {
            coinIcon.style.display = 'none';
          }
        }
        const prizeCoinIcon = document.getElementById(`prize-coin-icon-${i}`);
        if (prizeCoinIcon) {
          if (config.coinIcon) {
            prizeCoinIcon.src = config.coinIcon;
            prizeCoinIcon.style.width = '20px';
            prizeCoinIcon.style.height = '20px';
            prizeCoinIcon.style.marginRight = '5px';
            prizeCoinIcon.style.display = 'inline';
          } else {
            prizeCoinIcon.style.display = 'none';
          }
        }
      }
    }
  </script>
</body>
</html>
